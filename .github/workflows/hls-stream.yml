name: "6-Hour HLS to RTMP Stream (Auto Restart)"

on:
  schedule:
      - cron: "55 */5 * * *" 
  workflow_dispatch:  # Manual trigger
  push:               # Auto trigger when commit happens
    branches:
      - main

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update && sudo apt install ffmpeg python3 wget git -y
          wget -O logo.png "https://i.ibb.co/sdHxr15r/CURSED-STREAM-1.png"

      - name: Start Stream
        run: |
          python3 - <<'EOF'
          import subprocess, time

          STREAM_INPUT = "http://firstclass007.com:8080/play/live.php?mac=00:1A:79:01:70:9F&stream=642541&extension=m3u8"
          RTMP_OUTPUT = "rtmp://ovsu.okcdn.ru/input/1081439512_1081439512_43_lcoq56a4be"

          def start_stream():
            return subprocess.Popen([
                "ffmpeg", "-re",
                "-i", STREAM_INPUT,
                "-i", "logo.png",
                "-filter_complex", "overlay=10:10",
                "-vcodec", "libx264",
                "-vprofile", "baseline",
                "-g", "30",
                "-acodec", "aac",
                "-strict", "-2",
                "-f", "flv",
                RTMP_OUTPUT
            ])


          process = start_stream()
          while True:
              time.sleep(30)
              if process.poll() is not None:
                  print("Stream stopped! Restarting FFmpeg...")
                  process = start_stream()
          EOF

      - name: Auto-restart (commit to trigger again)
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          echo "Restarted: $(date)" > last_run.txt
          git add last_run.txt
          git commit -m "Auto-restart stream $(date)" || echo "No changes to commit"
          git push
          
