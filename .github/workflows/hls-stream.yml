name: "6-Hour HLS to RTMP Stream (Python Watchdog with Scaled Image & Text)"

on:
  workflow_dispatch:  # Manual start only

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Max 6 hours
    steps:
      - name: Install Dependencies
        run: |
          sudo apt update && sudo apt install ffmpeg python3 wget -y
          wget -O logo.png "https://i.ibb.co/cSjZ9PS2/logo.jpg"

      - name: Start Streaming with Python Watchdog
        run: |
          python3 - <<EOF
          import os, time, subprocess

          STREAM_INPUT = "https://fifabd.site/MACx/TATACC/play.php?id=2085"  # Replace with your HLS input
          RTMP_OUTPUT = "rtmp://origin.cdn.wowza.com/live/0I5p29eyiNQfDPf1zjDosD4gmydC5937"  # Replace with your RTMP server

          def start_stream():
              return subprocess.Popen([
                "ffmpeg", "-re", "-i", STREAM_INPUT,
                "-i", "logo.png",
                "-filter_complex", "[0:v]scale=-2:min(720,ih)[video]; "  # Scale video to at most 720p
                                "[1:v]scale=iw*min(0.1*iw\\, 0.1*ih)/iw:-1[logo]; "  # Scale logo to 10% of video width
                                "[video][logo]overlay=10:10, "  # Position logo in top-left corner
                                "drawtext=text='For promotion contact @pengutvapp': "
                                "fontcolor=white: fontsize=24: "  # Use a fixed size for now
                                "box=1: boxcolor=black@0.8: boxborderw=10: x=(w-text_w)/2: y=10",  # Center text at the top
                "-c:v", "libx264", "-preset", "veryfast", "-b:v", "2000k", "-maxrate", "2500k", "-bufsize", "3000k",
                "-c:a", "aac", "-b:a", "128k", "-f", "flv", RTMP_OUTPUT
            ])


          process = start_stream()

          while True:
              time.sleep(30)
              if process.poll() is not None:  # If FFmpeg stops, restart it
                  print("Stream stopped! Restarting FFmpeg...")
                  process = start_stream()
          EOF
